name: Azure Static Web Apps CI/CD

pr:
  branches:
    include:
      - master
trigger:
  branches:
    include:
      - master
  paths:
    include:
      - TodoApp.WebApp/Client
      - azure-pipelines-build-deploy-web-frontend.yml

stages:
  - stage: Buid
    jobs:
    - job: build_and_publish_job
      displayName: Build and Deploy Job
      condition: or(eq(variables['Build.Reason'], 'Manual'),or(eq(variables['Build.Reason'], 'PullRequest'),eq(variables['Build.Reason'], 'IndividualCI')))
      pool:
        vmImage: ubuntu-latest
      variables:
      - group: Azure-Static-Web-Apps-kind-field-08e5a8a10-variable-group
      steps:
      
      - checkout: self
        submodules: true
      - task: NodeAndNpmTool@1
        inputs:
         versionSpec: 18.x

      - task: Npm@1
        name: Run_Npm_Install
        inputs:
          command: 'install'
          workingDir: 'TodoApp.WebApp/Client'
      

      - task: Npm@1
        name: buildAngularWebPackage
        inputs:
          command: custom
          customCommand: run build --configuration=production
          workingDir: 'TodoApp.WebApp/Client'
      
      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'TodoApp.WebApp/Client/dist/todoapp.client'
          includeRootFolder: true
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
          replaceExistingArchive: true
      
      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
          publishLocation: 'pipeline'

  - stage: deploy
    dependsOn: Buid
    condition: and(succeeded(), or(eq(variables['Build.Reason'], 'Manual')))
    
    jobs:
      - job: deploy_job
        displayName: Deploy Job
        pool:
          vmImage: ubuntu-latest
        variables:
        - group: Azure-Static-Web-Apps-kind-field-08e5a8a10-variable-group
        steps:
          - task: DownloadPipelineArtifact@1
            inputs:
              buildType: current
              targetPath: '$(System.ArtifactsDirectory)'
          - task: ExtractFiles@1
            inputs:
              cleanDestinationFolder: true
              archiveFilePatterns: '$(System.ArtifactsDirectory)/**/$(Build.BuildId).zip'
              destinationFolder: '$(Build.ArtifactStagingDirectory)/extract-web'

          - task: AzureStaticWebApp@0
            inputs:
              azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_KIND_FIELD_08E5A8A10)
              skip_app_build: true
              workingDirectory: '$(Build.ArtifactStagingDirectory)'
              app_location: '/extract-web/todoapp.client'
              
              